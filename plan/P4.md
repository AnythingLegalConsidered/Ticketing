Absolument. Attaquons-nous à la **Partie 4**.

Le déploiement de Zammad est l'étape la plus complexe jusqu'à présent, car il ne s'agit pas d'un seul service, mais d'une pile de plusieurs conteneurs qui doivent fonctionner en harmonie (l'application, la base de données, le moteur de recherche, le planificateur de tâches, etc.). Nous allons suivre la structure recommandée par la documentation officielle de Zammad, en l'adaptant à notre projet.

**Attention :** Zammad et son moteur de recherche (Elasticsearch) sont gourmands en ressources, notamment en RAM. Assurez-vous d'avoir au moins 4 Go de RAM libres pour que le démarrage se passe bien. Dans le cadre de ce projet, tout tourne en environnement de test / lab sur votre machine locale.

---

### **Partie 4 : Second Service Applicatif (Zammad)**

#### **4.1. Déploiement de Zammad**

Nous allons ajouter l'ensemble des services Zammad à notre `docker-compose.yml`.

1.  **Déclarez les volumes nommés** pour Zammad. Ajoutez ces lignes à la fin de votre fichier `docker-compose.yml`, dans la section `volumes`.

    ```yaml
    # ... (autres volumes) ...
    volumes:
      ldap_data:
      ldap_config:
      snipeit_data:
      mariadb_snipeit_data:
      zammad_data:
      zammad_postgres_data:
      zammad_es_data:
    ```

2.  **Ajoutez tous les services Zammad** à la fin de votre section `services:` dans le `docker-compose.yml`. C'est un gros bloc, alors faites attention à l'indentation.

    ```yaml
    # ... (service snipe-it) ...

      # --- ZAMMAD STACK ---
      zammad-postgres:
        image: postgres:15
        container_name: zammad-postgres
        hostname: zammad-postgres
        restart: unless-stopped
        environment:
          - POSTGRES_USER=${POSTGRES_USER}
          - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          - POSTGRES_DB=${POSTGRES_DB}
        volumes:
          - zammad_postgres_data:/var/lib/postgresql/data
        networks:
          - it_stack_net

      zammad-elasticsearch:
        image: elasticsearch:7.17.10
        container_name: zammad-elasticsearch
        hostname: zammad-elasticsearch
        restart: unless-stopped
        environment:
          - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
        volumes:
          - zammad_es_data:/usr/share/elasticsearch/data
        networks:
          - it_stack_net
      
      zammad-app:
        image: zammad/zammad:6.2.0-14
        container_name: zammad-app
        hostname: zammad-app
        restart: unless-stopped
        depends_on:
          zammad-postgres:
            condition: service_started
          zammad-elasticsearch:
            condition: service_started
        environment:
          - POSTGRESQL_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@zammad-postgres:5432/${POSTGRES_DB}
          - ELASTICSEARCH_URL=http://zammad-elasticsearch:9200
          - TZ=${TZ}
        volumes:
          - zammad_data:/opt/zammad/
        networks:
          - it_stack_net

      zammad-scheduler:
        image: zammad/zammad:6.2.0-14
        container_name: zammad-scheduler
        hostname: zammad-scheduler
        restart: unless-stopped
        depends_on:
          - zammad-app
        volumes:
          - zammad_data:/opt/zammad/
        networks:
          - it_stack_net

      zammad-websocket:
        image: zammad/zammad:6.2.0-14
        container_name: zammad-websocket
        hostname: zammad-websocket
        restart: unless-stopped
        depends_on:
          - zammad-app
        volumes:
          - zammad_data:/opt/zammad/
        networks:
          - it_stack_net

      zammad-nginx:
        image: zammad/zammad:6.2.0-14
        container_name: zammad-nginx
        hostname: zammad-nginx
        restart: unless-stopped
        depends_on:
          - zammad-app
        ports:
          # IMPORTANT: Nous n'exposons PAS ce port à l'hôte.
          # Notre Nginx principal s'en chargera.
          - "127.0.0.1:8080:80"
        volumes:
          - zammad_data:/opt/zammad/
        networks:
          - it_stack_net
    
    # ... (sections networks et volumes) ...
    ```

    **Explications :**
    *   Nous avons ajouté 6 services : `zammad-postgres` (DB), `zammad-elasticsearch` (recherche), `zammad-app` (le cœur), et trois services de support (`scheduler`, `websocket`, `nginx`).
    *   **Communication Interne :** Tous les services sont sur `it_stack_net` et communiquent entre eux par leur nom (ex: `zammad-app` contacte `zammad-postgres`).
    *   **Volume Partagé :** Le volume nommé `zammad_data` est partagé entre plusieurs conteneurs Zammad pour les assets, ce qui est crucial.
    *   **Nginx de Zammad :** Le service `zammad-nginx` est le serveur web fourni par Zammad. Nous ne l'exposons *pas* directement au monde extérieur. Au lieu de cela, nous le lions à `127.0.0.1:8080` sur l'hôte Docker. C'est notre Nginx principal qui recevra le trafic public et le transmettra à ce port.

#### **4.2. Configuration de Nginx pour Zammad**

Nous devons créer la configuration pour que notre Nginx principal (celui que nous avons déployé à la Partie 1) relaie les requêtes vers la pile Zammad.

1.  **Créez le fichier de configuration** pour Zammad :

    ```bash
    touch nginx/conf.d/zammad.conf
    ```

2.  **Remplissez le fichier `nginx/conf.d/zammad.conf`**. Cette configuration est un peu plus complexe car elle doit gérer les WebSockets, nécessaires pour les mises à jour en temps réel de Zammad.

    ```nginx
    server {
        listen 80;
        server_name zammad.projet.lan;

        # Augmente la taille maximale des fichiers uploadés (ex: pièces jointes)
        client_max_body_size 50M;

        location / {
            proxy_pass http://zammad-nginx:80; # On cible le Nginx interne de Zammad
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Configuration requise pour les WebSockets
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
    ```

#### **4.3. TEST ET VALIDATION (Phase 1 - Déploiement)**

Lançons la pile et vérifions que tout est accessible.

1.  **Démarrez l'ensemble des services Zammad.**

    ```bash
    docker compose up -d
    ```
    Cette commande peut prendre plusieurs minutes. Docker va télécharger les nouvelles images et démarrer les 6 conteneurs de Zammad. Elasticsearch, en particulier, peut être long à initialiser.

2.  **Surveillez les logs (optionnel mais recommandé).** Pour voir la progression, vous pouvez suivre les logs du conteneur `zammad-app`.

    ```bash
    docker compose logs -f zammad-app
    ```
    Attendez que les messages d'erreur disparaissent et que le serveur semble être en attente de connexions. Appuyez sur `Ctrl+C` pour arrêter le suivi.

3.  **Mettez à jour votre fichier `hosts`**. Ajoutez le domaine de Zammad.

    ```
    127.0.0.1    mail.projet.lan snipeit.projet.lan zammad.projet.lan
    ```

4.  **Vérifiez le résultat.** Ouvrez votre navigateur et accédez à l'URL :

    **`http://zammad.projet.lan`**

    Après un temps de chargement, vous devriez être accueilli par l'écran de configuration de Zammad, vous invitant à créer un nouveau compte administrateur.

---

**Bilan de la Partie 4**

Mission accomplie ! Si vous voyez la page de configuration de Zammad, cela signifie que :
*   Les 6 conteneurs de la pile Zammad ont démarré et communiquent correctement.
*   La base de données et le moteur de recherche ont été initialisés.
*   Notre reverse proxy Nginx est capable de router le trafic, y compris les connexions WebSocket, vers la pile Zammad.

Tous nos services sont maintenant déployés ! La prochaine étape, la **Partie 5**, consistera à réaliser la configuration initiale de chaque service via leur interface web pour les faire communiquer ensemble (LDAP et SMTP).