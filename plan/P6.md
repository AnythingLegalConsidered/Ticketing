Absolument. Voici le détail complet de la **Partie 6**.

L'objectif de cette partie est de rendre notre déploiement entièrement autonome. Nous allons identifier toutes les actions manuelles que nous avons effectuées dans la Partie 5 et les transformer en scripts. Le but final est qu'après un `docker compose up`, un seul script suffise pour obtenir une stack 100% configurée et interconnectée.

---

### **Partie 6 : Automatisation de la Configuration Post-Déploiement**

#### **6.1. Analyse des actions manuelles à scripter**

Recensons précisément ce que nous avons fait manuellement dans les interfaces web :

1.  **Pour Snipe-IT :**
    *   Configuration du serveur SMTP (serveur `mailhog`, port `1025`, pas de chiffrement).
    *   Activation de LDAP.
    *   Configuration de la connexion LDAP (serveur, identifiants de liaison, DN de base).
    *   Configuration du mapping des attributs LDAP (nom, prénom, e-mail).
    *   Lancement de la première synchronisation LDAP.

2.  **Pour Zammad :**
    *   Configuration du canal e-mail sortant (type SMTP, serveur `mailhog`, port `1025`).
    *   Activation de l'intégration LDAP.
    *   Configuration de la connexion LDAP (serveur, identifiants de liaison, DN de base).
    *   Configuration du filtre utilisateur et du mapping des attributs.
    *   Lancement de la première synchronisation LDAP.

#### **6.2. Développement du script d'automatisation pour Zammad**

Zammad est une application Ruby on Rails. Le moyen le plus propre de la configurer par script est d'utiliser la console Rails pour interagir directement avec les modèles de l'application.

1.  **Créez le fichier de script Ruby** dans le dossier `zammad/`.

    ```bash
    touch zammad/configure_zammad.rb
    ```

2.  **Remplissez `zammad/configure_zammad.rb`** avec le code Ruby suivant. Ce script va directement écrire les paramètres dans la base de données de Zammad.

    ```ruby
    # Ce script s'exécute dans le contexte de la console Rails de Zammad.

    puts ":: Configuring Zammad ::"

    # --- Configuration Email sortant (SMTP) ---
    puts "--> Configuring Outbound Email (SMTP)..."
    begin
      setting = Setting.find_by(name: 'system_email_sender_address')
      setting.value = 'notifications@zammad.projet.lan'
      setting.save!

      email_channel = Channel.find_or_create_by(area: 'Email::Out')
      email_channel.options = {
        adapter: 'smtp',
        options: {
          host: 'mailhog',
          port: 1025,
          # D'autres options peuvent être ajoutées ici si nécessaire (user, password, ssl, etc.)
        }
      }
      email_channel.active = true
      email_channel.save!
      puts "SMTP settings configured."
    rescue => e
      warn "An error occurred during SMTP configuration: #{e.message}"
    end

    # --- Configuration LDAP ---
    puts "--> Configuring LDAP Integration..."
    begin
      ldap_config = LdapSource.first_or_initialize
      ldap_config.name        = 'OpenLDAP Integration'
      ldap_config.host        = 'openldap'
      ldap_config.port        = 389
      ldap_config.user_dn     = "cn=admin,dc=projet,dc=lan"
      # IMPORTANT: Le mot de passe sera lu depuis une variable d'environnement du conteneur
      ldap_config.password    = ENV['LDAP_ROOT_PASSWORD']
      ldap_config.base_dn     = 'dc=projet,dc=lan'
      ldap_config.user_filter = '(objectClass=inetOrgPerson)'
      ldap_config.user_uid    = 'uid'
      ldap_config.user_attributes = {
        'firstname' => 'givenName',
        'lastname'  => 'sn',
        'email'     => 'mail'
      }
      ldap_config.active = true
      ldap_config.save!

      # --- Lancement de la synchronisation LDAP ---
      puts "--> Starting LDAP sync job..."
      LdapSource.sync(ldap_config.id)
      puts "LDAP configuration and initial sync complete."

    rescue => e
      warn "An error occurred during LDAP configuration: #{e.message}"
    end

    puts ":: Zammad configuration finished. ::"
    ```

3.  **Mettez à jour `docker-compose.yml`** pour que le script soit accessible dans le conteneur `zammad-app` et pour lui passer le mot de passe LDAP.

    ```yaml
    # ...
      zammad-app:
        # ... (image, container_name, etc.)
        environment:
          # ... (autres variables)
          - LDAP_ROOT_PASSWORD=${LDAP_ROOT_PASSWORD} # Ajout de cette ligne
        volumes:
          - zammad_data:/opt/zammad/
          - ./zammad/configure_zammad.rb:/opt/zammad/configure_zammad.rb # Ajout de cette ligne
    # ...
    ```

#### **6.3. Développement du script d'automatisation pour Snipe-IT**

Snipe-IT est basé sur Laravel (PHP) et peut être configuré via son outil en ligne de commande `php artisan`. Ce sera une suite de commandes `docker compose exec`.

1.  **Créez un script shell** dans le dossier `snipe-it/`.

    ```bash
    touch snipe-it/configure_snipeit.sh
    ```

2.  **Remplissez `snipe-it/configure_snipeit.sh`** avec les commandes suivantes :

    ```bash
    #!/bin/bash
    # Ce script configure Snipe-IT en utilisant des commandes artisan.

    echo ":: Configuring Snipe-IT ::"

    # Attente pour s'assurer que l'application est prête à accepter des commandes
    sleep 20 

    # Configuration SMTP
    echo "--> Configuring SMTP..."
    docker compose exec snipe-it php artisan config:set mail.default 'smtp'
    docker compose exec snipe-it php artisan config:set mail.mailers.smtp.host 'mailhog'
    docker compose exec snipe-it php artisan config:set mail.mailers.smtp.port '1025'
    docker compose exec snipe-it php artisan config:set mail.mailers.smtp.encryption null
    docker compose exec snipe-it php artisan config:set mail.from.address 'notifications@snipeit.projet.lan'
    docker compose exec snipe-it php artisan config:set mail.from.name 'Snipe-IT'

    # Configuration LDAP
    echo "--> Configuring LDAP..."
    docker compose exec snipe-it php artisan config:set ldap.enabled true
    docker compose exec snipe-it php artisan config:set ldap.server 'ldap://openldap'
    docker compose exec snipe-it php artisan config:set ldap.username "cn=admin,dc=projet,dc=lan"
    docker compose exec snipe-it php artisan config:set ldap.password "${LDAP_ROOT_PASSWORD}"
    docker compose exec snipe-it php artisan config:set ldap.basedn "ou=users,dc=projet,dc=lan"
    docker compose exec snipe-it php artisan config:set ldap.filter '(objectClass=inetOrgPerson)'
    docker compose exec snipe-it php artisan config:set ldap.username_field 'uid'
    docker compose exec snipe-it php artisan config:set ldap.lname_field 'sn'
    docker compose exec snipe-it php artisan config:set ldap.fname_field 'givenName'
    docker compose exec snipe-it php artisan config:set ldap.email_field 'mail'

    # Mise en cache de la nouvelle configuration
    echo "--> Caching new configuration..."
    docker compose exec snipe-it php artisan config:cache

    # Synchronisation LDAP
    echo "--> Running LDAP sync..."
    docker compose exec snipe-it php artisan snipeit:ldap-sync -L

    echo ":: Snipe-IT configuration finished. ::"
    ```

#### **6.4. Création du script maître (`configure.sh`)**

Ce script sera le point d'entrée unique pour lancer toute la configuration.

1.  **Créez le script `configure.sh`** à la racine de votre projet.

    ```bash
    touch configure.sh
    ```

2.  **Remplissez `configure.sh`** avec le contenu suivant :

    ```bash
    #!/bin/bash

    echo "================================================="
    echo "Starting automated configuration of the IT Stack"
    echo "================================================="

    echo "Waiting for all services to be fully up... (60 seconds)"
    sleep 60

    echo -e "\n----- Configuring Zammad -----"
    docker compose exec zammad-app rails runner /opt/zammad/configure_zammad.rb
    echo "----- Zammad configuration complete -----"

    echo -e "\n----- Configuring Snipe-IT -----"
    bash ./snipe-it/configure_snipeit.sh
    echo "----- Snipe-IT configuration complete -----"

    echo -e "\n================================================="
    echo "✅ Automated configuration finished!"
    echo "================================================="
    ```

3.  **Rendez les scripts exécutables :**

    ```bash
    chmod +x configure.sh
    chmod +x snipe-it/configure_snipeit.sh
    ```

#### **6.5. TEST FINAL**

C'est l'heure de vérité. Nous allons simuler un déploiement depuis zéro dans notre environnement de test / lab.

1.  **Détruisez complètement votre environnement actuel (lab).** L'option `-v` est **cruciale** car elle supprime les volumes de données, nous assurant un départ à neuf. Cela efface définitivement toutes les données (tickets, inventaire, utilisateurs). **Ne faites cela que dans ce contexte de test / lab.**

    ```bash
    docker compose down -v
    ```

2.  **Remontez toute la stack.**

    ```bash
    docker compose up -d
    ```

3.  **Lancez le script d'automatisation.**

    ```bash
    ./configure.sh
    ```

4.  **Validez le résultat :** Une fois le script terminé, attendez une minute ou deux que les synchronisations se fassent, puis :
    *   **Connectez-vous à Zammad** (`http://zammad.projet.lan`) avec l'utilisateur `johndoe` et le mot de passe `password`.
    *   **Connectez-vous à Snipe-IT** (`http://snipeit.projet.lan`) avec l'utilisateur `johndoe` et le mot de passe `password`.
    *   Vérifiez dans les interfaces d'administration que les configurations SMTP et LDAP sont bien présentes.

---

**Bilan de la Partie 6**

Si les tests de connexion sont réussis, le projet a atteint son objectif principal :
*   Nous avons un déploiement "one-click" (ou presque).
*   La configuration est maintenant versionnée et reproductible, ce qui élimine les erreurs humaines.
*   Le projet est beaucoup plus facile à partager et à redéployer.

La dernière étape, **Partie 7**, consistera à finaliser la documentation pour que n'importe qui puisse utiliser votre projet.