Parfait. Continuons avec la **Partie 2**.

L'objectif est de déployer et de configurer notre service d'annuaire OpenLDAP. C'est un composant central, car Zammad et Snipe-IT s'appuieront sur lui pour l'authentification des utilisateurs. Nous allons l'initialiser automatiquement avec une structure de base pour ne pas avoir à le faire manuellement.

---

### **Partie 2 : Le Service d'Identité (OpenLDAP)**

#### **2.1. Préparation de la configuration OpenLDAP**

Pour que notre annuaire soit prêt à l'emploi dès le premier démarrage, nous allons lui fournir un fichier de configuration au format LDIF (`LDAP Data Interchange Format`). Ce fichier créera notre domaine, un utilisateur administrateur, et les "Unités Organisationnelles" (OU) pour stocker nos utilisateurs et nos groupes.

1.  **Créez le fichier `bootstrap.ldif`** dans le dossier `openldap/` que nous avions déjà créé.

    ```bash
    touch openldap/bootstrap.ldif
    ```

2.  **Remplissez le fichier `openldap/bootstrap.ldif`** avec le contenu suivant. Ce code est basé sur le domaine `projet.lan` que nous avons défini dans notre fichier `.env`.

    ```ldif
    # This LDIF file defines the basic structure for our directory
    # It will be automatically imported on the first start of the OpenLDAP container.

    # Entry for the 'users' Organizational Unit
    dn: ou=users,dc=projet,dc=lan
    objectClass: organizationalUnit
    ou: users

    # Entry for the 'groups' Organizational Unit
    dn: ou=groups,dc=projet,dc=lan
    objectClass: organizationalUnit
    ou: groups
    ```
    
    **Explication :**
    *   `dc=projet,dc=lan` est la représentation LDAP de notre domaine `projet.lan`.
    *   Nous créons deux conteneurs : `ou=users` pour stocker les comptes utilisateurs, et `ou=groups` pour les groupes.

#### **2.2. Déploiement d'OpenLDAP**

Nous allons maintenant ajouter le service OpenLDAP à notre `docker-compose.yml`. Nous utilisons l'image `osixia/openldap`, qui est très populaire et bien documentée pour ce cas d'usage.

1.  **Ajoutez les volumes nommés** pour OpenLDAP en haut de votre `docker-compose.yml`, sous la section `networks`.

    ```yaml
    # ... (services: section) ...

    networks:
      it_stack_net:
        driver: bridge

    volumes:
      ldap_data:
      ldap_config:
    ```    *C'est une bonne pratique de déclarer explicitement les volumes ici.*

2.  **Ajoutez le service `openldap`** à la section `services:` de votre `docker-compose.yml`.

    ```yaml
    # ... (service nginx) ...
    
      openldap:
        image: osixia/openldap:1.5.0
        container_name: openldap
        hostname: openldap
        environment:
          - LDAP_ORGANISATION="Projet LAN"
          - LDAP_DOMAIN=${DOMAIN}
          - LDAP_ADMIN_PASSWORD=${LDAP_ROOT_PASSWORD}
          - LDAP_CONFIG_PASSWORD=${LDAP_ROOT_PASSWORD}
        volumes:
          - ldap_data:/var/lib/ldap
          - ldap_config:/etc/ldap/slapd.d
          - ./openldap/bootstrap.ldif:/container/service/slapd/assets/config/bootstrap/ldif/05-base-structure.ldif
        networks:
          - it_stack_net
        restart: unless-stopped
    
    # ... (networks: et volumes: sections) ...
    ```

    **Explications :**
    *   `image: osixia/openldap:1.5.0`: Nous fixons la version pour assurer la reproductibilité.
    *   `environment`: Nous configurons l'image en utilisant les variables de notre fichier `.env`. L'image utilisera `LDAP_DOMAIN` pour créer la base `dc=projet,dc=lan`.
    *   `volumes`:
        *   `ldap_data` et `ldap_config` sont les volumes nommés pour la persistance des données.
        *   La troisième ligne est cruciale : elle injecte notre fichier `bootstrap.ldif` dans le conteneur à un endroit spécifique où l'image le trouvera et l'importera au premier démarrage. Le préfixe `05-` assure qu'il s'exécute après la configuration de base.

#### **2.3. TEST ET VALIDATION**

Il faut maintenant vérifier que le conteneur a bien démarré et que notre structure de base a été créée.

1.  **Lancez le conteneur OpenLDAP.** Comme les autres services sont déjà lancés, Docker Compose ne lancera que le nouveau.

    ```bash
    docker compose up -d openldap
    ```

2.  **Inspectez les logs.** C'est la première étape de vérification.

    ```bash
    docker compose logs openldap
    ```
    Faites défiler les logs. Vous devriez voir des lignes indiquant que les fichiers LDIF sont importés, y compris notre fichier `05-base-structure.ldif`. Si vous ne voyez pas d'erreurs, c'est bon signe.

3.  **Interrogez l'annuaire.** Pour être absolument certain, nous allons interroger l'annuaire avec la commande `ldapsearch` depuis un conteneur temporaire. C'est la méthode la plus fiable.

    Exécutez la commande suivante dans votre terminal. **N'oubliez pas de remplacer `VotreMotDePasseLDAP` par le mot de passe que vous avez défini dans votre fichier `.env` pour `LDAP_ROOT_PASSWORD`**.

    ```bash
    docker run --rm --network it-stack-project_it_stack_net bitnami/openldap:latest ldapsearch -x -H ldap://openldap -b "dc=projet,dc=lan" -D "cn=admin,dc=projet,dc=lan" -w "VotreMotDePasseLDAP"
    ```
    
    *(Note : le nom du réseau peut varier légèrement. Si la commande échoue, vérifiez le nom exact avec `docker network ls`)*.

    **Explication de la commande :**
    *   `docker run --rm --network ...`: Lance un conteneur temporaire sur le même réseau que nos services.
    *   `ldapsearch -x`: Utilise une authentification simple.
    *   `-H ldap://openldap`: Cible notre serveur LDAP (le nom `openldap` est résolu par Docker).
    *   `-b "dc=projet,dc=lan"`: Définit la base de la recherche.
    *   `-D "cn=admin,..."`: Se connecte en tant qu'administrateur.
    *   `-w "..."`: Utilise le mot de passe fourni.

    **Résultat attendu :**
    Si tout s'est bien passé, vous devriez voir un résultat qui contient les entrées que nous avons créées, comme ceci :

    ```
    # extended LDIF
    #
    # LDAPv3
    # base <dc=projet,dc=lan> with scope subtree
    # filter: (objectclass=*)
    # requesting: ALL
    #

    # projet.lan
    dn: dc=projet,dc=lan
    objectClass: top
    objectClass: dcObject
    objectClass: organization
    o: Projet LAN
    dc: projet

    # admin, projet.lan
    dn: cn=admin,dc=projet,dc=lan
    objectClass: simpleSecurityObject
    objectClass: organizationalRole
    cn: admin
    description: LDAP administrator

    # users, projet.lan
    dn: ou=users,dc=projet,dc=lan
    objectClass: organizationalUnit
    ou: users

    # groups, projet.lan
    dn: ou=groups,dc=projet,dc=lan
    objectClass: organizationalUnit
    ou: groups

    # search result
    search: 2
    result: 0 Success

    # numResponses: 5
    # numEntries: 4
    ```

---

  ### **Automatisation du bootstrap**

  Pour simplifier le démarrage en laboratoire, un petit wrapper est fourni dans le dossier `scripts/` :

  - `scripts/start.ps1` (Windows PowerShell)
  - `scripts/start.sh` (POSIX shell)

  Ces scripts exécutent :

  1. `docker compose up -d` — démarre tous les services en arrière-plan
  2. `docker compose run --rm ldap-bootstrap` — exécute le job one-shot qui attend `slapd` puis importe le LDIF
  3. Affiche les logs du job `ldap-bootstrap` (tail 200)

  Exemples d'utilisation :

  PowerShell (Windows) :
  ```powershell
  Set-Location 'C:\Pro\Ecole\Ticketing'
  .\scripts\start.ps1
  ```

  Bash (Linux / macOS / WSL) :
  ```sh
  cd /path/to/project
  ./scripts/start.sh
  ```

  Si vous préférez lancer manuellement le job bootstrap sans wrapper :

  ```sh
  docker compose up -d
  docker compose run --rm ldap-bootstrap
  ```

  Note : le job `ldap-bootstrap` lit `DOMAIN` et `LDAP_ROOT_PASSWORD` depuis votre fichier `.env` (géré automatiquement par Compose). Évitez de laisser de vrais secrets dans le dépôt.


**Bilan de la Partie 2**

Si vous avez obtenu le résultat ci-dessus, félicitations ! Nous disposons maintenant :
*   D'un serveur OpenLDAP fonctionnel et persistant.
*   D'un annuaire pré-configuré avec la structure de base nécessaire pour accueillir nos futurs utilisateurs et groupes.

Nous sommes prêts à déployer notre premier service applicatif qui utilisera cet annuaire : **Snipe-IT**, dans la **Partie 3**.