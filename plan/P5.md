Absolument. Passons à la **Partie 5**, l'étape cruciale où nous allons interconnecter nos services.

Jusqu'à présent, nous avons déployé des applications isolées. L'objectif de cette partie est de les configurer manuellement, via leurs interfaces web, pour qu'elles communiquent entre elles. Nous allons configurer l'envoi d'e-mails via MailHog et, plus important encore, l'authentification des utilisateurs via OpenLDAP.

---

### **Partie 5 : Intégration et Configuration Manuelle**

Avant de commencer, nous devons finaliser l'installation de Snipe-IT et Zammad en créant leurs comptes administrateurs respectifs.

*   **Snipe-IT :** Allez sur `http://snipeit.projet.lan`. Suivez les étapes de l'installateur :
    1.  Sur la page "Pre-Flight Check", cliquez sur "Next: Create Database Tables".
    2.  Sur la page "Create Database Tables", cliquez sur "Next: Create User".
    3.  Remplissez le formulaire pour créer votre utilisateur administrateur, puis connectez-vous.
*   **Zammad :** Allez sur `http://zammad.projet.lan`. Remplissez le formulaire pour créer votre compte administrateur.

#### **5.1. Intégration E-mail (via MailHog)**

Nous allons configurer chaque application pour qu'elle envoie ses e-mails à MailHog.

1.  **Configurer Snipe-IT pour MailHog :**
    *   Une fois connecté à Snipe-IT, cliquez sur l'icône "roue crantée" en haut à droite pour accéder aux "Admin Settings".
    *   Dans le menu de gauche, cliquez sur **Notifications**.
    *   Remplissez les paramètres de la section "Email Settings" comme suit :
        *   **Email Domain:** `projet.lan`
        *   **SMTP Server:** `mailhog`
        *   **SMTP Port:** `1025`
        *   **SMTP Username:** (laissez vide)
        *   **SMTP Password:** (laissez vide)
        *   **Email Encryption:** `None`
    *   Cliquez sur le bouton **Save** en bas.
    *   Ensuite, cliquez sur le bouton **Send Test** en haut pour envoyer un e-mail de test.

2.  **Configurer Zammad pour MailHog :**
    *   Une fois connecté à Zammad, cliquez sur l'icône "roue crantée" en bas à gauche pour aller dans les "Paramètres".
    *   Allez dans **Canaux -> E-mail**.
    *   Cliquez sur l'onglet **Paramètres** en haut.
    *   Dans la section "Notifications sortantes", entrez une adresse d'expéditeur, par exemple `notifications@zammad.projet.lan`.
    *   Choisissez la méthode de livraison **SMTP**.
    *   Remplissez les informations du serveur SMTP :
        *   **Hôte :** `mailhog`
        *   **Port :** `1025`
        *   **Utilisateur / Mot de passe :** (laissez vide)
    *   Cliquez sur **Soumettre**.
    *   En bas de la page, cliquez sur **Envoyer un e-mail de test**.

3.  **TEST ET VALIDATION :**
    *   Ouvrez MailHog en allant sur `http://mail.projet.lan`.
    *   **Objectif :** Vous devez voir les deux e-mails de test, l'un provenant de Snipe-IT et l'autre de Zammad.

#### **5.2. Préparation : Création d'un utilisateur de test dans OpenLDAP**

Pour tester l'intégration LDAP, nous avons besoin d'au moins un utilisateur dans notre annuaire. Nous allons l'ajouter via la ligne de commande.

1.  **Créez un fichier `test-user.ldif`** dans votre dossier `openldap/`.

    ```bash
    touch openldap/test-user.ldif
    ```

2.  **Remplissez ce fichier** avec le contenu suivant pour créer un utilisateur "John Doe".

    ```ldif
    dn: uid=johndoe,ou=users,dc=projet,dc=lan
    objectClass: inetOrgPerson
    objectClass: posixAccount
    objectClass: top
    cn: John Doe
    sn: Doe
    givenName: John
    uid: johndoe
    uidNumber: 10001
    gidNumber: 10000
    homeDirectory: /home/johndoe
    mail: john.doe@projet.lan
    userPassword: {SSHA}WdY8xBg5sC6h9M8h2Z9nAgA6V/r4fKjO
    ```
    *Note : le mot de passe est `password`. Ce compte est uniquement prévu pour les tests dans ce lab, ne l'utilisez jamais tel quel en production.*

3.  **Importez l'utilisateur** en exécutant une commande `ldapadd` à l'intérieur du conteneur `openldap`.

    ```bash
    docker compose exec openldap ldapadd -x -D "cn=admin,dc=projet,dc=lan" -w "${LDAP_ROOT_PASSWORD}" -f /container/service/slapd/assets/config/bootstrap/ldif/test-user.ldif
    ```
    *Il est possible que la commande ci-dessus échoue car le chemin du fichier n'est pas bon. Dans ce cas, nous allons monter le fichier au bon endroit dans le `docker-compose.yml`. Modifiez la section `openldap` pour y ajouter ce volume : `- ./openldap/test-user.ldif:/tmp/test-user.ldif` puis relancez `docker compose up -d`. La commande pour importer le fichier est maintenant :*
    `docker compose exec openldap ldapadd -x -D "cn=admin,dc=projet,dc=lan" -w "${LDAP_ROOT_PASSWORD}" -f /tmp/test-user.ldif`
    
    Vous devriez voir un message `adding new entry "uid=johndoe,ou=users,dc=projet,dc=lan"`.

#### **5.3. Intégration LDAP**

Maintenant, connectons nos applications à l'annuaire.

1.  **Configurer Snipe-IT pour OpenLDAP :**
    *   Dans les "Admin Settings" de Snipe-IT, allez dans **LDAP**.
    *   Activez "Enable LDAP" en haut.
    *   Remplissez les champs comme suit :
        *   **LDAP Server:** `ldap://openldap`
        *   **LDAP Bind Username:** `cn=admin,dc=projet,dc=lan`
        *   **LDAP Bind Password:** (votre mot de passe `LDAP_ROOT_PASSWORD` du fichier `.env`)
        *   **Base Bind DN:** `ou=users,dc=projet,dc=lan`
        *   **Username Field:** `uid`
        *   **Last Name:** `sn`
        *   **First Name:** `givenName`
        *   **LDAP Email:** `mail`
    *   Cliquez sur **Save**.
    *   Allez dans le menu de gauche **People** et cliquez sur **LDAP Sync**. Vous devriez voir un aperçu de l'utilisateur "John Doe". Cliquez sur **Sync**.

2.  **Configurer Zammad pour OpenLDAP :**
    *   Dans les "Paramètres" de Zammad, allez dans **Système -> Intégrations -> LDAP**.
    *   Cliquez sur "Ajouter une nouvelle configuration LDAP".
    *   Remplissez les champs :
        *   **Hôte :** `openldap`
        *   **Utilisateur de liaison :** `cn=admin,dc=projet,dc=lan`
        *   **Mot de passe de liaison :** (votre mot de passe `LDAP_ROOT_PASSWORD`)
        *   **DN de base :** `dc=projet,dc=lan`
        *   **Filtre utilisateur :** `(objectClass=inetOrgPerson)`
        *   **UID de l'utilisateur :** `uid`
    *   Dans la section "Mapping", associez les attributs :
        *   **Prénom :** `givenName`
        *   **Nom de famille :** `sn`
        *   **E-mail :** `mail`
    *   Activez la configuration en haut.
    *   Cliquez sur **Soumettre**.
    *   Une fois la page rechargée, cliquez sur **Synchroniser maintenant**.

3.  **TEST ET VALIDATION :**
    *   **Dans Snipe-IT :** Allez dans "People". Vous devriez voir "John Doe" dans la liste.
    *   **Dans Zammad :** Allez dans "Utilisateurs". Vous devriez voir "John Doe".
    *   **Test final :** Déconnectez-vous des deux applications. Essayez de vous connecter à chacune avec le nom d'utilisateur `johndoe` et le mot de passe `password`. La connexion doit réussir.

---

**Bilan de la Partie 5**

Félicitations ! C'est une étape majeure. Nous avons maintenant :
*   Une stack entièrement déployée ET interconnectée.
*   Les e-mails transactionnels sont capturés par MailHog.
*   L'authentification et les utilisateurs sont centralisés dans OpenLDAP.

Le système est pleinement fonctionnel. La prochaine et dernière étape, la **Partie 6**, consistera à prendre toutes ces actions manuelles que nous venons d'effectuer et à les scripter pour rendre le déploiement entièrement automatique.