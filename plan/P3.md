Entendu, nous passons à la **Partie 3**.

Notre objectif est de déployer Snipe-IT, notre outil de gestion d'inventaire. C'est notre premier service applicatif "complexe", car il dépend d'une base de données externe (MariaDB) et nécessite une configuration un peu plus poussée, notamment la génération d'une clé d'application unique.

---

### **Partie 3 : Premier Service Applicatif (Snipe-IT)**

#### **3.1. Déploiement de Snipe-IT**

Cette étape consiste à ajouter deux nouveaux services à notre `docker-compose.yml` : `mariadb-snipeit` (la base de données) et `snipe-it` (l'application).

1.  **Déclarez les volumes nommés** pour Snipe-IT et sa base de données. Ajoutez ces lignes à la fin de votre fichier `docker-compose.yml`, dans la section `volumes`.

    ```yaml
    # ... (autres volumes) ...
    volumes:
      ldap_data:
      ldap_config:
      snipeit_data:
      mariadb_snipeit_data:
    ```

2.  **Ajoutez les services `mariadb-snipeit` et `snipe-it`** à votre `docker-compose.yml`, dans la section `services:`.

    ```yaml
    # ... (service openldap) ...

      mariadb-snipeit:
        image: mariadb:10.6
        container_name: mariadb-snipeit
        hostname: mariadb-snipeit
        command: --default-authentication-plugin=mysql_native_password
        environment:
          - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
          - MYSQL_DATABASE=${MYSQL_DATABASE}
          - MYSQL_USER=${MYSQL_USER}
          - MYSQL_PASSWORD=${MYSQL_PASSWORD}
        volumes:
          - mariadb_snipeit_data:/var/lib/mysql
        networks:
          - it_stack_net
        restart: unless-stopped

      snipe-it:
        image: snipe/snipe-it:v6.3.3
        container_name: snipe-it
        hostname: snipe-it
        depends_on:
          - mariadb-snipeit
        environment:
          - TZ=${TZ}
          - PUID=${PUID}
          - PGID=${PGID}
          - MYSQL_PORT_3306_TCP_ADDR=mariadb-snipeit
          - MYSQL_PORT_3306_TCP_PORT=3306
          - MYSQL_DATABASE=${MYSQL_DATABASE}
          - MYSQL_USER=${MYSQL_USER}
          - MYSQL_PASSWORD=${MYSQL_PASSWORD}
          - APP_URL=http://snipeit.${DOMAIN}
          - APP_KEY=${SNIPEIT_APP_KEY}
        volumes:
          - snipeit_data:/var/lib/snipeit
        networks:
          - it_stack_net
        restart: unless-stopped

    # ... (sections networks et volumes) ...
    ```

    **Explications :**
    *   **`mariadb-snipeit`** : Un service MariaDB standard. Nous utilisons les variables du fichier `.env` pour créer la base de données (`snipeit`) et un utilisateur dédié. Le volume `mariadb_snipeit_data` assure la persistance des données.
    *   **`snipe-it`** : Le service applicatif.
        *   `image: snipe/snipe-it:v6.3.3`: Nous fixons la version pour la stabilité.
        *   `depends_on`: S'assure que la base de données est démarrée avant l'application.
        *   `environment`: C'est ici que nous lions Snipe-IT à sa base de données (`MYSQL_..._ADDR=mariadb-snipeit`) et que nous définissons son URL publique (`APP_URL`).
        *   `APP_KEY=${SNIPEIT_APP_KEY}`: Cette variable est cruciale pour la sécurité de Snipe-IT. Pour l'instant, elle est vide dans notre `.env`. Nous allons la générer à l'étape de validation.

#### **3.2. Configuration de Nginx pour Snipe-IT**

Comme pour MailHog, nous devons dire à Nginx de rediriger le trafic pour `snipeit.projet.lan` vers le conteneur Snipe-IT.

1.  **Créez un nouveau fichier de configuration** pour Snipe-IT dans `nginx/conf.d/`.

    ```bash
    touch nginx/conf.d/snipeit.conf
    ```

2.  **Remplissez le fichier `nginx/conf.d/snipeit.conf`** avec le contenu suivant :

    ```nginx
    server {
        listen 80;
        server_name snipeit.projet.lan;

        location / {
            proxy_pass http://snipe-it:80;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
    ```
    *C'est quasiment la même configuration que pour MailHog, mais le `proxy_pass` pointe vers le service `snipe-it` sur son port 80.*

#### **3.3. TEST ET VALIDATION (Phase 1 - Déploiement)**

Cette étape est un peu différente car nous devons effectuer une action intermédiaire pour générer la clé d'application.

1.  **Démarrez les nouveaux services.** Exécutez la commande `up` depuis la racine de votre projet. Docker Compose est assez intelligent pour ne démarrer que les nouveaux services (`mariadb-snipeit`, `snipe-it`) et recréer Nginx pour charger la nouvelle configuration.

    ```bash
    docker compose up -d
    ```    Le conteneur `snipe-it` va démarrer mais ne sera pas fonctionnel, c'est normal. Il attend sa clé `APP_KEY`.

2.  **Générez la clé d'application.** Nous allons exécuter une commande à l'intérieur du conteneur `snipe-it` pour qu'il génère sa clé.

    ```bash
    docker compose exec snipe-it php artisan key:generate --force --show
    ```
    Cette commande va afficher une longue chaîne de caractères qui commence par `base64:`. **Copiez cette chaîne complète.**

3.  **Mettez à jour votre fichier `.env`**. Ouvrez votre fichier `.env` et collez la clé que vous venez de copier à la ligne `SNIPEIT_APP_KEY=`. Cela devrait ressembler à ceci :
    
    `SNIPEIT_APP_KEY=base64:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx=`

4.  **Redémarrez les services** pour qu'ils prennent en compte la nouvelle variable d'environnement.

    ```bash
    docker compose up -d --force-recreate
    ```

5.  **Mettez à jour votre fichier `hosts`**. Comme pour MailHog, ajoutez le domaine de Snipe-IT. Ouvrez votre fichier `hosts` (avec `sudo`) et ajoutez la nouvelle ligne :

    ```
    127.0.0.1    mail.projet.lan snipeit.projet.lan
    ```
    *(Vous pouvez simplement l'ajouter à côté du domaine existant pour garder le fichier propre).*

6.  **Vérifiez le résultat.** Ouvrez votre navigateur et accédez à l'URL :

    **`http://snipeit.projet.lan`**

    Après un court instant de chargement (le premier démarrage peut être un peu long), vous devriez voir la page d'installation de Snipe-IT intitulée **"Snipe-IT Pre-Flight Check"**.

---

**Bilan de la Partie 3**

Si vous voyez la page "Pre-Flight Check", c'est un grand succès ! Nous avons :
*   Déployé avec succès un service applicatif dépendant d'une base de données.
*   Géré un cas de configuration spécifique (la génération de l'APP_KEY).
*   Correctement configuré Nginx pour router le trafic vers notre nouveau service.

L'application est prête mais pas encore configurée. Nous effectuerons la configuration finale (création de l'admin, etc.) plus tard. Pour l'instant, la validation du déploiement est terminée. Nous sommes prêts pour la **Partie 4**, le déploiement de Zammad.

---

### **Mise à jour — 2025-11-17 (état actuel)**

- **Reachability**: J'ai validé la page de pré‑installation `http://snipeit.projet.lan/setup` via Nginx — la page renvoie HTTP 200 et affiche l'écran "Snipe-IT Pre-Flight".
- **APP_KEY**: Une clé `APP_KEY` a été générée (via l'image officielle) et écrite dans `./.env` sous `SNIPEIT_APP_KEY`.
- **Nginx**: Pour permettre un test immédiat sans modifier `hosts`, j'ai temporairement configuré `nginx/conf.d/snipeit.conf` avec `listen 80 default_server;` afin que `http://localhost` (ou une requête avec `Host: snipeit.projet.lan`) soit proxifiée vers le conteneur `snipe-it`.
- **Notes DNS/hosts**: L'accès depuis un navigateur avec l'URL `http://snipeit.projet.lan` nécessite d'ajouter la ligne suivante dans `C:\Windows\System32\drivers\etc\hosts` :

```
127.0.0.1 snipeit.projet.lan
```

- **Etat des migrations**: Les migrations apparaissent avoir été exécutées (logs de `snipe-it` montrent l'exécution des migrations). La page `/setup` propose toutefois les étapes suivantes (migrate → create user) au besoin.

### **Prochaines étapes recommandées (P3)**

1. Accéder à `http://snipeit.projet.lan/setup` dans un navigateur (après ajout au `hosts`) et suivre l'assistant pour :
  - exécuter "Create Database Tables" si nécessaire (le bouton `/setup/migrate`),
  - créer l'utilisateur administrateur (page `/setup/user`),
  - configurer l'envoi d'e-mails (MailHog est déjà disponible sur `mail.projet.lan`).
2. Décider si l'on doit restaurer MailHog en tant que vhost par défaut dans Nginx (si oui, retirer `default_server` dans `snipeit.conf` et reload Nginx). Sinon laisser Snipe‑IT par défaut jusqu'à la fin des validations.
3. Sécuriser : configurer SSL (certificat auto-signé pour labo ou via Let's Encrypt si exposé), et revoir les permissions/accès sur `.env`.
4. Documenter dans `plan/P3.md` les valeurs `.env` nécessaires et vérifier qu'elles ne sont pas exposées publiquement.

---

Je passe ensuite à la **Partie 4** (Zammad) si vous validez que l'état actuel vous convient. Je préparerai les services `postgresql` + `zammad` dans `docker-compose.yml`, la configuration Nginx et l'intégration LDAP.