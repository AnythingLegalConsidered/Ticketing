Excellent. Passons à la **Partie 1**.

L'objectif ici est de mettre en place les services les plus simples de notre stack, MailHog et Nginx, et de valider leur communication. C'est le socle sur lequel nous construirons le reste.

---

### **Partie 1 : Le Socle Technique de Base (Services Indépendants)**

#### **1.1. Déploiement de MailHog**

MailHog est un outil de test d'e-mails très simple à déployer. Nous allons l'ajouter à notre `docker-compose.yml`.

1.  **Ouvrez votre fichier `docker-compose.yml`** et ajoutez le service `mailhog` sous une nouvelle section `services:`.

    ```yaml
    version: '3.8'

    services:
      mailhog:
        image: mailhog/mailhog:latest
        container_name: mailhog
        hostname: mailhog
        ports:
          # Port SMTP pour que les autres services envoient des e-mails
          - "1025:1025"
          # Port de l'interface web (accessible uniquement depuis le réseau Docker)
          - "8025:8025"
        environment:
          - TZ=${TZ}
        networks:
          - it_stack_net
        restart: unless-stopped

    networks:
      it_stack_net:
        driver: bridge
    ```

    **Explications :**
    *   `image: mailhog/mailhog:latest` : Utilise l'image Docker officielle de MailHog.
    *   `container_name` & `hostname`: Nomme le conteneur pour une identification facile.
    *   `ports`: Nous exposons les ports `1025` (pour recevoir les e-mails) et `8025` (pour l'interface web).
    *   `environment`: Nous réutilisons la variable `TZ` de notre fichier `.env` pour la cohérence du fuseau horaire.
    *   `networks`: Nous connectons le conteneur à notre réseau partagé `it_stack_net`.

#### **1.2. Déploiement du Reverse Proxy Nginx**

Nginx sera notre point d'entrée unique. Il redirigera le trafic vers le bon service en fonction du nom de domaine demandé.

1.  **Ajoutez le service `nginx` à votre fichier `docker-compose.yml`**, juste après le service `mailhog`.

    ```yaml
    # ... (le service mailhog est au-dessus)
    
      nginx:
        image: nginx:1.25-alpine
        container_name: nginx
        hostname: nginx
        ports:
          - "80:80"
          - "443:443"
        volumes:
          - ./nginx/conf.d:/etc/nginx/conf.d
        depends_on:
          - mailhog
        networks:
          - it_stack_net
        restart: unless-stopped
    
    # ... (la définition du network est en dessous)
    ```

    **Explications :**
    *   `image: nginx:1.25-alpine`: Utilise une image Nginx légère et versionnée.
    *   `ports`: Lie les ports `80` (HTTP) et `443` (HTTPS) de votre machine hôte aux ports du conteneur. Dans ce projet de lab, nous utilisons uniquement HTTP en local, sans chiffrement TLS.
    *   `volumes`: C'est le point clé. Nous montons le dossier local `./nginx/conf.d` dans le conteneur. Tout fichier de configuration que nous créerons dans ce dossier local sera lu par Nginx.
    *   `depends_on`: Indique à Docker Compose de démarrer MailHog avant Nginx.

2.  **Créez le fichier de configuration pour MailHog**. Dans le dossier `nginx/`, créez un sous-dossier `conf.d/`. À l'intérieur de `conf.d/`, créez un nouveau fichier nommé `mailhog.conf`.

    ```bash
    # Si vous n'avez pas encore créé le sous-dossier, faites-le
    mkdir -p nginx/conf.d

    # Créez le fichier de configuration
    touch nginx/conf.d/mailhog.conf
    ```

3.  **Remplissez le fichier `nginx/conf.d/mailhog.conf`** avec le contenu suivant :

    ```nginx
    server {
        listen 80;
        server_name mail.projet.lan;

        location / {
            proxy_pass http://mailhog:8025;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
    ```

    **Explications :**
    *   `listen 80;`: Nginx écoute le trafic HTTP sur le port 80.
    *   `server_name mail.projet.lan;`: Si une requête arrive avec ce nom de domaine, Nginx utilisera ce bloc de configuration.
    *   `proxy_pass http://mailhog:8025;`: C'est la magie. Nginx redirige la requête vers le service nommé `mailhog` (que Docker résout en interne) sur son port web `8025`.

#### **1.3. TEST ET VALIDATION**

Il est temps de vérifier que tout fonctionne.

1.  **Lancez les conteneurs** depuis la racine de votre projet :

    ```bash
    docker compose up -d
    ```
    Vous devriez voir les conteneurs `mailhog` et `nginx` se créer et démarrer.

2.  **Modifiez votre fichier `hosts`**. Pour que votre navigateur sache que `mail.projet.lan` doit pointer vers votre machine locale (où Docker s'exécute), vous devez ajouter une ligne à votre fichier `hosts`.

    *   **Sur Linux ou macOS :**
        Ouvrez le fichier avec des droits d'administrateur : `sudo nano /etc/hosts`
    *   **Sur Windows :**
        Ouvrez le Bloc-notes en tant qu'administrateur et ouvrez le fichier `C:\Windows\System32\drivers\etc\hosts`

    Ajoutez la ligne suivante à la fin du fichier :

    ```
    127.0.0.1    mail.projet.lan
    ```
    Enregistrez et fermez le fichier.

3.  **Vérifiez le résultat.** Ouvrez votre navigateur web et accédez à l'URL :

    **`http://mail.projet.lan`**

    Si tout est correct, **vous devriez voir l'interface web de MailHog**.

---

**Bilan de la Partie 1**

Nous avons maintenant :
*   Un conteneur MailHog fonctionnel.
*   Un conteneur Nginx qui agit comme un reverse proxy.
*   Une première route configurée qui expose MailHog de manière sécurisée et propre via un nom de domaine local.

Si vous voyez l'interface de MailHog, nous sommes prêts à passer à la **Partie 2** pour déployer OpenLDAP.